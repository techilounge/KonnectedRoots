rules_version = '2';

// Rules for Firebase Storage
service firebase.storage {
  // Match the bucket for your project
  match /b/{bucket}/o {

    // Secure the path for profile picture uploads
    // - Users can only upload to a tree they own.
    // - Files must be images.
    // - Files must be less than 5MB.
    match /trees/{treeId}/people/{personId}/{fileName} {
      allow write: if request.auth != null
                    && request.resource.size < 5 * 1024 * 1024
                    && request.resource.contentType.matches('image/.*')
                    && firestore.get(/databases/(default)/documents/trees/$(treeId)).data.ownerId == request.auth.uid;
      
      // Allow anyone to read profile pictures for now. 
      // This can be tightened later if needed.
      allow read;
    }
  }
}
