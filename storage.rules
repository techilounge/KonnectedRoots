rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    function authed() {
      return request.auth != null;
    }

    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }

    function under5MB() {
      return request.resource.size < 5 * 1024 * 1024;
    }

    // IMPORTANT: use (default) when reading Firestore from Storage rules
    // Check if user is owner OR has edit permissions (editor/manager)
    function canEditTree(treeId) {
      let treeData = firestore.get(/databases/(default)/documents/trees/$(treeId)).data;
      let uid = request.auth.uid;
      return authed() && (
        treeData.ownerId == uid || 
        (uid in treeData.collaborators && (treeData.collaborators[uid] == 'editor' || treeData.collaborators[uid] == 'manager'))
      );
    }

    // Check if user can read (owner OR any collaborator role)
    function canReadTree(treeId) {
      let treeData = firestore.get(/databases/(default)/documents/trees/$(treeId)).data;
      let uid = request.auth.uid;
      return authed() && (
        treeData.ownerId == uid || 
        uid in treeData.collaborators
      );
    }

    // Profile photos & media for people inside trees
    match /trees/{treeId}/people/{personId}/{fileName} {
      // SECURITY NOTE: Currently public read for shared tree previews and exports.
      // URLs are unpredictable (tree ID + person ID + filename).
      // To require authentication, change to: allow read: if canReadTree(treeId);
      allow read: if true;

      // User must have edit rights to the tree
      allow write: if canEditTree(treeId) && isImage() && under5MB();
    }

    // (Optional but recommended) add a Storage rule for user avatars
    match /users/{uid}/profile/{fileName} {
      allow read: if true; // or authed() if you prefer private
      allow write: if authed() && request.auth.uid == uid
                   && request.resource.size < 5 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*');
    }
  }
}
