rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Helper function to check if the user is the owner of the tree.
    // This function looks up the tree document in Firestore to verify ownership.
    function isTreeOwner(treeId) {
      return exists(/databases/$(database)/documents/trees/$(treeId)) &&
             get(/databases/$(database)/documents/trees/$(treeId)).data.ownerId == request.auth.uid;
    }

    // Rules for profile pictures associated with a person in a specific tree.
    match /trees/{treeId}/people/{personId}/{fileName} {
      // Allow anyone to read images, as they need to be publicly visible in the app.
      allow read: if true;
      
      // Only allow writes (uploads) if the user is authenticated and is the owner of the tree.
      allow write: if request.auth != null && isTreeOwner(treeId);
    }
  }
}
