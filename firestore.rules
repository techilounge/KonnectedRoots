rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // A user can read/write their own user profile document.
    // Any authenticated user can query users by email (for invitations)
    match /users/{userId} {
      // Anyone authenticated can read user profiles (needed for invitations)
      allow read: if request.auth != null;
      // Only the user can update their own profile
      allow update: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
    }

    // Rules for the 'trees' collection and its 'people' subcollection.
    // Rules for the 'trees' collection and its 'people' subcollection.
    match /trees/{treeId} {
      // Helper function to check if user is owner
      function isOwner() {
        return request.auth != null && resource.data.ownerId == request.auth.uid;
      }
      
      // Helper function to check if user is a collaborator
      function isCollaborator() {
        return request.auth != null && resource.data.collaborators[request.auth.uid] != null;
      }

      // Helper function to check collaborator role
      function hasRole(role) {
        return request.auth != null && resource.data.collaborators[request.auth.uid] == role;
      }

      // A user can create a tree for themselves.
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      
      // Owner can do anything. Collaborators can read. Managers can update.
      // Also allow authenticated users to read if querying by slug (for SEO-friendly URL lookup)
      allow read: if isOwner() || isCollaborator();
      allow update: if isOwner() || hasRole('manager');
      allow delete: if isOwner();

      // Rules for the 'people' subcollection within a tree.
      match /people/{personId} {
        function rootIsOwner() {
          return get(/databases/$(database)/documents/trees/$(treeId)).data.ownerId == request.auth.uid;
        }
        
        function rootHasRole(role) {
          let treeData = get(/databases/$(database)/documents/trees/$(treeId)).data;
          return treeData.collaborators[request.auth.uid] == role;
        }
        
        function rootIsCollaborator() {
          let treeData = get(/databases/$(database)/documents/trees/$(treeId)).data;
          return treeData.collaborators[request.auth.uid] != null;
        }

        // Owner can do anything.
        // Viewers can read.
        // Editors and Managers can write.
        allow read: if rootIsOwner() || rootIsCollaborator();
        allow write, delete: if rootIsOwner() || rootHasRole('editor') || rootHasRole('manager');
      }

      // Rules for 'layoutHistory' subcollection
      match /layoutHistory/{snapshotId} {
        function rootIsOwner() {
          return get(/databases/$(database)/documents/trees/$(treeId)).data.ownerId == request.auth.uid;
        }
        
        function rootIsCollaborator() {
          let treeData = get(/databases/$(database)/documents/trees/$(treeId)).data;
          return treeData.collaborators[request.auth.uid] != null;
        }
        
        function rootHasRole(role) {
          let treeData = get(/databases/$(database)/documents/trees/$(treeId)).data;
          return treeData.collaborators[request.auth.uid] == role;
        }

        // Viewers can see history
        allow read: if rootIsOwner() || rootIsCollaborator();
        
        // Only Editors/Managers/Owners can create or delete snapshots
        allow create, delete: if rootIsOwner() || rootHasRole('editor') || rootHasRole('manager');
      }
    }

    // ONE-TIME MIGRATION RULE: Allow any authenticated user to read the old, top-level 'people' collection.
    // This is required for the "Fix Member Counts" button to find and move the orphaned data.
    // This rule can be removed after the migration is complete for enhanced security.
    // match /people/{personId} {
    //   allow read, delete: if request.auth != null;
    // }

    // Invitations collection for tree collaboration
    match /invitations/{invitationId} {
      // Anyone authenticated can create an invitation (for their own trees)
      allow create: if request.auth != null && request.resource.data.inviterUid == request.auth.uid;
      
      // SECURITY NOTE: Public read is intentional for invite preview UX.
      // Users need to see "You've been invited by X to tree Y" before logging in.
      // Invitation IDs are auto-generated (unpredictable), no collection listing is possible.
      // Only basic metadata is exposed (inviter name, tree name, role).
      allow read: if true;
      
      // Inviter can update (resend) and delete their invitations
      allow update, delete: if request.auth != null && resource.data.inviterUid == request.auth.uid;
      
      // Invitee can update (accept/decline) their invitations
      allow update: if request.auth != null && request.auth.token.email == resource.data.inviteeEmail;
      
      // Allow update by inviteeUid if set
      allow update: if request.auth != null && resource.data.inviteeUid == request.auth.uid;
    }

    // Notifications collection for in-app notifications
    match /notifications/{notificationId} {
      // Only the recipient can read their notifications
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Only the recipient can update (mark as read)
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Any authenticated user can create notifications (for invites, etc.)
      allow create: if request.auth != null;
    }

    // Families collection for Family plan workspaces
    match /families/{familyId} {
      // Helper: check if user is family owner
      function isFamilyOwner() {
        return request.auth != null && resource.data.ownerUid == request.auth.uid;
      }
      
      // Helper: check if user is a family member
      function isFamilyMember() {
        return request.auth != null && 
          exists(/databases/$(database)/documents/families/$(familyId)/seats/$(request.auth.uid));
      }
      
      // Owner and members can read family data
      allow read: if isFamilyOwner() || isFamilyMember();
      
      // Only owner can update family settings
      allow update: if isFamilyOwner();
      
      // Families are created by Cloud Functions (checkout flow)
      allow create: if false;
      allow delete: if false;
      
      // Family seats subcollection
      match /seats/{seatId} {
        // Family owner can manage seats
        allow read, write: if get(/databases/$(database)/documents/families/$(familyId)).data.ownerUid == request.auth.uid;
        
        // Users can read their own seat
        allow read: if request.auth != null && request.auth.uid == seatId;
      }
    }

    // Billing events collection (for audit trail, managed by Cloud Functions)
    match /billing_events/{eventId} {
      // No client access - only Cloud Functions write here
      allow read, write: if false;
    }
  }
}
